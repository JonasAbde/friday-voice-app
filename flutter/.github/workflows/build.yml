name: Flutter CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Run tests and linting
  test:
    name: Test and Lint
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    - name: Get dependencies
      run: flutter pub get
      working-directory: friday-voice-app/flutter
    
    - name: Run analyzer
      run: flutter analyze
      working-directory: friday-voice-app/flutter
    
    - name: Run tests
      run: flutter test
      working-directory: friday-voice-app/flutter

  # Build Android APK
  build-android:
    name: Build Android
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    - name: Get dependencies
      run: flutter pub get
      working-directory: friday-voice-app/flutter
    
    - name: Build debug APK
      run: flutter build apk --debug
      working-directory: friday-voice-app/flutter
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v3
      with:
        name: android-debug-apk
        path: friday-voice-app/flutter/build/app/outputs/flutter-apk/app-debug.apk
        retention-days: 7

  # Build Android Release (only on main branch)
  build-android-release:
    name: Build Android Release
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    # Decode keystore from secrets (base64 encoded)
    - name: Decode keystore
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/release.keystore
      working-directory: friday-voice-app/flutter
    
    # Create key.properties from secrets
    - name: Create key.properties
      run: |
        cat > android/key.properties << EOF
        storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
        keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
        storeFile=release.keystore
        EOF
      working-directory: friday-voice-app/flutter
    
    - name: Get dependencies
      run: flutter pub get
      working-directory: friday-voice-app/flutter
    
    - name: Build release APK
      run: |
        flutter build apk --release \
          --split-per-abi \
          --obfuscate \
          --split-debug-info=build/app/outputs/symbols
      working-directory: friday-voice-app/flutter
    
    - name: Upload release APKs
      uses: actions/upload-artifact@v3
      with:
        name: android-release-apks
        path: friday-voice-app/flutter/build/app/outputs/flutter-apk/*.apk
        retention-days: 30
    
    - name: Upload debug symbols
      uses: actions/upload-artifact@v3
      with:
        name: android-debug-symbols
        path: friday-voice-app/flutter/build/app/outputs/symbols
        retention-days: 90

  # Build iOS (macOS only)
  build-ios:
    name: Build iOS
    needs: test
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    - name: Get dependencies
      run: flutter pub get
      working-directory: friday-voice-app/flutter
    
    - name: Install CocoaPods
      run: |
        cd ios
        pod install --repo-update
      working-directory: friday-voice-app/flutter
    
    - name: Build iOS (no codesign)
      run: flutter build ios --debug --no-codesign
      working-directory: friday-voice-app/flutter
    
    - name: Upload iOS build
      uses: actions/upload-artifact@v3
      with:
        name: ios-debug-build
        path: friday-voice-app/flutter/build/ios/iphoneos/Runner.app
        retention-days: 7
